name: Notion Dashboard Sync

on:
  schedule:
    # Update dashboard every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      full_refresh:
        description: 'Perform full dashboard refresh'
        required: false
        default: false
        type: boolean
  push:
    paths:
      - 'scripts/notion_unified_dashboard.py'
      - '.github/workflows/notion_dashboard_sync.yml'

env:
  NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
  NOTION_DASHBOARD_PAGE_ID: ${{ secrets.NOTION_DASHBOARD_PAGE_ID }}
  NOTION_PERFORMANCE_DB_ID: ${{ secrets.NOTION_PERFORMANCE_DB_ID }}
  NOTION_INCIDENT_DB_ID: ${{ secrets.NOTION_INCIDENT_DB_ID }}
  NOTION_ALERTS_DB_ID: ${{ secrets.NOTION_ALERTS_DB_ID }}
  TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
  POWERBI_MONITOR_PUSH_URL: ${{ secrets.POWERBI_MONITOR_PUSH_URL }}

jobs:
  sync-dashboard:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install notion-client requests
        
    - name: Create or update dashboard
      run: |
        python scripts/notion_unified_dashboard.py
      env:
        FULL_REFRESH: ${{ github.event.inputs.full_refresh }}
        
    - name: Sync metrics from all sources
      run: |
        python scripts/sync_dashboard_metrics.py
        
    - name: Generate dashboard report
      run: |
        python scripts/generate_dashboard_report.py
        
    - name: Upload dashboard artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dashboard-sync-${{ github.run_number }}
        path: |
          notion_dashboard_structure.json
          dashboard_report.html
        retention-days: 7
        
    - name: Notify completion
      if: always()
      run: |
        python scripts/send_notification.py \
          --status "${{ job.status }}" \
          --workflow "Notion Dashboard Sync" \
          --message "Dashboard updated with latest metrics"